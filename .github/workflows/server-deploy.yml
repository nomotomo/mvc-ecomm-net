name: Build to ECR & Deploy EC2

on:
  push:
    branches: [ main ]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECR_REPOSITORY_PREFIX: ${{ secrets.ECR_REPOSITORY }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    strategy:
      matrix:
        service: 
          - catalog.api
          - basket.api
          - discount.api
          - ordering.api
          - payment.api
          - identity.api
          - ocelot.apigateway
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build ${{ matrix.service }} image
        env:
          ECR_REGISTRY_URL: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          case "${{ matrix.service }}" in
            catalog.api)
              DOCKERFILE="Services/Catalog/Catalog.API/Dockerfile"
              ;;
            basket.api)
              DOCKERFILE="Services/Basket/Basket.API/Dockerfile"
              ;;
            discount.api)
              DOCKERFILE="Services/Discount/Discount.API/Dockerfile"
              ;;
            ordering.api)
              DOCKERFILE="Services/Ordering/Ordering.API/Dockerfile"
              ;;
            payment.api)
              DOCKERFILE="Services/Payment/Payment.API/Dockerfile"
              ;;
            identity.api)
              DOCKERFILE="Services/Identity/Identity.API/Dockerfile"
              ;;
            ocelot.apigateway)
              DOCKERFILE="ApiGateway/ApiGateway/Dockerfile"
              ;;
          esac
          
          docker build . -f "$DOCKERFILE" \
            -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service }}:latest \
            -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service }}:${{ env.IMAGE_TAG }}

      - name: Push ${{ matrix.service }} image to ECR
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service }}:latest
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service }}:${{ env.IMAGE_TAG }}
          echo "✅ Pushed ${{ matrix.service }} with tags: latest, ${{ env.IMAGE_TAG }}"

  deploy-to-ec2:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: AWS_REGION,AWS_ACCOUNT_ID,ECR_REGISTRY
          script: |
            set -e
            
            # ECR Login
            aws ecr get-login-password --region $AWS_REGION | \
              docker login --username AWS --password-stdin $ECR_REGISTRY
            
            # Navigate to repo
            cd /home/ec2-user/mvc-ecomm-net
            
            # Pull latest code
            git pull origin main
            
            # Create .env file for production
            cat > .env << EOF
            ECR_REGISTRY=$ECR_REGISTRY
            TAG=latest
            EOF
            
            # Pull all images from ECR
            docker compose -f docker-compose.prod.yaml --env-file .env pull
            
            # Stop and remove old containers
            docker compose -f docker-compose.prod.yaml down --remove-orphans || true
            
            # Start all services with health checks
            docker compose -f docker-compose.prod.yaml --env-file .env up -d --wait
            
            # Verify services are running
            echo "✅ Services deployed successfully:"
            docker compose -f docker-compose.prod.yaml ps
            
            # Optional: Check service health
            docker compose -f docker-compose.prod.yaml ps --format "table {{.Service}}\t{{.Status}}"
